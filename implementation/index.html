<!doctype html>
<meta charset="utf-8">
<script src="BeforeInstallPromptEvent.js">
</script>
<style>
@keyframes fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

#installprompt {
  animation: fadein 2s;
  width: 10cm;
  padding: 1cm;
}
</style>
<button onclick="notifyBeforeInstallPrompt(this)">
  Simulate install BIP
</button>
<button onclick="showInstallPrompt(this)">
  Simulate manual "Add to Home Screen"
</button>
<script>
/*globals BeforeInstallPromptEvent, DOMException*/
"use strict"; {
  const assertion = "No arguments should throw";
  try {
    new BeforeInstallPromptEvent();
    console.assert(false, assertion);
  } catch (err) {
    console.assert(true, assertion);
  }
} {
  const assertion = "First argument stringifies";
  try {
    const e = new BeforeInstallPromptEvent(undefined);
    console.assert(e.type === "undefined", assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    const e = new BeforeInstallPromptEvent(null);
    console.assert(e.type === "null", assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    const e = new BeforeInstallPromptEvent(12);
    console.assert(e.type === "12", assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    const e = new BeforeInstallPromptEvent("beforeinstallprompt");
    console.assert(e.type === "beforeinstallprompt", assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    const e = new BeforeInstallPromptEvent("");
    console.assert(e.type === "", assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    const e = new BeforeInstallPromptEvent("\t\n");
    console.assert(e.type === "\t\n", assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
} {
  const assertion = "handles empty optional eventInit options";
  try {
    new BeforeInstallPromptEvent("");
    console.assert(true, assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    new BeforeInstallPromptEvent("", undefined);
    console.assert(true, assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
  try {
    new BeforeInstallPromptEvent("", null);
    console.assert(true, assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
} {
  const assertion = "throws on invalid eventInit options";
  try {
    new BeforeInstallPromptEvent("", "");
    console.assert(false, assertion);
  } catch (err) {
    console.assert(true, assertion);
  }
  try {
    new BeforeInstallPromptEvent("", 123);
    console.assert(false, assertion);
  } catch (err) {
    console.assert(true, assertion);
  }
} {
  const assertion = "accepts AppBannerPromptOutcome enum values";
  try {
    new BeforeInstallPromptEvent("", {
      userChoice: undefined
    });
    new BeforeInstallPromptEvent("", {
      userChoice: "accepted"
    });
    new BeforeInstallPromptEvent("", {
      userChoice: "dismissed"
    });
    console.assert(true, assertion);
  } catch (err) {
    console.assert(false, assertion, err);
  }
} {
  const assertion = "throws on invalid AppBannerPromptOutcome enum values";
  try {
    new BeforeInstallPromptEvent("", {
      userChoice: null
    });
    console.assert(false, assertion);
  } catch (err) {
    console.assert(true, assertion);
  }
  try {
    new BeforeInstallPromptEvent("", {
      userChoice: 123
    });
    console.assert(false, assertion);
  } catch (err) {
    console.assert(true, assertion);
  }
  try {
    new BeforeInstallPromptEvent("", {
      userChoice: "not-a-valid-option"
    });
    console.assert(false, assertion);
  } catch (err) {
    console.assert(true, assertion);
  }
} {
  const assertion = "BeforeInstallPromptEvent is cancelable by default";
  const e1 = new BeforeInstallPromptEvent("");
  console.assert(e1.cancelable === true, assertion);
  const e2 = new BeforeInstallPromptEvent("", {
    cancelable: true
  });
  console.assert(e2.cancelable === true, assertion);
  const e3 = new BeforeInstallPromptEvent("", {
    cancelable: false
  });
  console.assert(e3.cancelable === false, assertion);
} {
  const assertion = "BeforeInstallPromptEvent has a userChoice attribute";
  const e1 = new BeforeInstallPromptEvent("");
  console.assert("userChoice" in e1, assertion);
} {
  const assertion = "userChoice is a Promise";
  const e1 = new BeforeInstallPromptEvent("");
  console.assert(e1.userChoice instanceof Promise, assertion);
} {
  const assertion = "Correctly sets userChoice enum values";
  const e1 = new BeforeInstallPromptEvent("", {
    userChoice: "accepted"
  });
  e1.userChoice
    .then(value => console.assert(value === "accepted"))
    .catch(err => console.assert(false, assertion, err));
  const e2 = new BeforeInstallPromptEvent("", {
    userChoice: "dismissed"
  });
  e2.userChoice
    .then(value => console.assert(value === "dismissed"))
    .catch(err => console.assert(false, assertion, err));
} {
  const assertion = "BeforeInstallPromptEvent has a prompt() method";
  const e = new BeforeInstallPromptEvent("");
  console.assert("prompt" in e, assertion);
} {
  const assertion = "prompt() is a function";
  const e = new BeforeInstallPromptEvent("");
  console.assert(e.prompt instanceof Function, assertion);
} {
  const assertion = "prompt() takes no arguments";
  const e = new BeforeInstallPromptEvent("");
  console.assert(e.prompt.length === 0, assertion);
} {
  const assertion = "calling prompt() with untrusted event throws NotAllowedError";
  const e = new BeforeInstallPromptEvent("");
  try {
    e.prompt();
    console.assert(false, assertion);
  } catch (err) {
    console.assert(err instanceof DOMException, assertion);
    console.assert(err.name == "NotAllowedError", assertion);
  }
}

// install events
window.addEventListener("appinstalled", (ev) => {
  console.info("Application installed successfully");
});

window.addEventListener('beforeinstallprompt', function test1(e) {
  console.info("Running test 1");
  window.removeEventListener("beforeinstallprompt", test1);
  const assertion = "Throws when preventDefault not called";
  try {
    e.prompt();
    console.assert(false, assertion);
  } catch (err) {
    console.assert(err.name === "InvalidStateError", assertion);
  }
  try {
    e.preventDefault();
    e.prompt();
    window.addEventListener("appinstalled", setupTest2);
  } catch (err) {
    console.assert(false, "Unexpected exceptions");
  } {
    const msg = "Calling prompt() again results in InvalidStateError";
    try {
      e.prompt();
      console.assert(false, assertion);
    } catch (err) {
      console.assert(err.name === "InvalidStateError", assertion);
    }
  }
});


// Trusted events
function setupTest2() {
  console.log("setting up test 2");
  window.addEventListener("beforeinstallprompt", function test2(ev) {
    window.removeEventListener("beforeinstallprompt", test2);
    // run tests
    {
      const assertion = "only fires after document is fully loaded";
      console.assert(document.readyState === "complete", assertion);
    } {
      const assertion = "is instance of BeforeInstallPromptEvent";
      console.assert(ev instanceof BeforeInstallPromptEvent, assertion);
    } {
      const assertion = "is trusted";
      console.assert(ev.isTrusted, assertion, ev);
    } {
      const assertion = "calling prompt successfully returns void";
      ev.preventDefault();
      console.assert(typeof ev.prompt() === "undefined", assertion);
    } {
      const assertion = "Calling prompt() again will throw InvalidStateError";
      try {
        ev.prompt();
        console.assert(false, assertion);
      } catch (err) {
        console.assert(err instanceof DOMException, assertion);
        console.assert(err.name == "InvalidStateError", assertion);
      }
    }
    console.log("Done test 2");
  });
}
</script>
